# Frontend â†”ï¸ Backend API Contract

This document lists the backend endpoints the frontend depends on to deliver the scenarios, classroom analytics, and reporting features described in `features.md`. Every endpoint uses JSON for request/response bodies unless noted otherwise and is namespaced under `/api`.

## ðŸ” Teacher authentication & classroom preparation

### POST `/api/auth/login`
Authenticate a teacher so they can configure classrooms and monitor live sessions.
- **Request body**
  ```json
  {
    "email": "teacher@school.fi",
    "password": "string"
  }
  ```
- **Success response** `200 OK`
  ```json
  {
    "teacherId": "64f1a...",
    "token": "jwt-token",
    "expiresInSeconds": 3600
  }
  ```
- **Errors**: `401` invalid credentials, `423` account locked.

### POST `/api/teachers/{teacherId}/sessions`
Create a classroom session that contains baseline context (location, monthly income, cohort metadata) used to seed scenarios. Sessions begin in a **waiting** state until the teacher manually starts them.
- **Request body**
  ```json
  {
    "sessionName": "Business Studies 2B",
    "location": "Espoo",
    "monthlyIncome": 1200
  }
  ```
- **Success response** `201 Created`
  ```json
  {
    "sessionId": "sess_72cf",
    "joinCode": "Q9L3KD",
    "status": "waiting_for_start"
  }
  ```
- **Errors**: `400` validation failure.

### POST `/api/teachers/{teacherId}/sessions/{sessionId}/start`
Once every student has joined, the teacher triggers the live simulation. This flips the session status from `waiting_for_start` to `in_progress` and unpauses scenario delivery.

- **Success response** `202 Accepted`
  ```json
  {
    "sessionId": "sess_72cf",
    "status": "in_progress",
    "startedAt": "2025-11-15T08:37:12Z"
  }
  ```
- **Errors**: `409` already started, `404` session not found.

### GET `/api/teachers/{teacherId}/sessions`
List all waiting, live, and historical sessions for dashboard selection.
- **Response** `200`
  ```json
  [
    {
      "sessionId": "sess_72cf",
      "sessionName": "Business Studies 2B",
      "joinCode": "Q9L3KD",
      "status": "in_progress",
      "startedAt": "2025-11-15T08:35:00Z",
      "playerCount": 24
    }
  ]
  ```

## ðŸŽ® Player onboarding & gameplay loop

### POST `/api/sessions/{joinCode}/students`
Students join a session using the teacher-provided code and nickname.
- **Request body**
  ```json
  {
    "userName": "Nova",
  }
  ```
- **Success response** `201`
  ```json
  {
    "sessionId": "sess_72cf",
    "studentId": "stud_19ab",
    "seatNumber": 17,
    "initialStats": {
      "wealth": 0,
      "health": 0,
      "happiness": 0,
      "scenariosDone": []
    }
  }
  ```
- **Errors**: `404` invalid join code, `409` nickname already in use.

### GET `/api/sessions/{sessionId}/students/{studentId}`
Fetch the player dashboard (visible stats + hidden attributes) for live updates.
- **Response** `200`
  ```json
  {
    "stats": {
      "wealth": 32,
      "health": 18,
      "happiness": 45,
      "scenariosDone": ["scn_92fa0bff"]
    }
  }
  ```

### GET `/api/sessions/{sessionId}/next-scenario`
Provide the next scenario (core or personalized) for the requesting student. Scenarios and any follow-up prompts are generated by an LLM and are delivered as narrative text â€” there is no typed `expectedAnswerType`. Scenario IDs are opaque, generated strings (e.g. `scn_b58c3d72-1e8a-4af5-a0c6-c0ef987ad123`); do not rely on them being human-readable.
- **Query params**: `studentId`, optional `previousScenarioId`
- **Response** `200`
  ```json
  {
    "scenarioId": "scn_b58c3d72-1e8a-4af5-a0c6-c0ef987ad123",
    "title": "Secure Your First Apartment",
    "scenarioText": "You're starting university in a new city, you need to find an affordable apartment and balance study/work â€” explain your first steps and priorities."
  }
  ```

**Gameplay loop overview**
1. Student requests a scenario (endpoint above) and the UI renders the `scenarioText`.
2. Student sends conversational turns through `POST /api/sessions/{sessionId}/prompts/{promptId}`. Each response contains the AI's next message.
3. When the backend LLM determines objectives are satisfied, that same response returns `status: "completed"`, an `accepted` signal, and the stat-change summary.
4. The UI displays the summary and, when the student taps **Next scenario**, it calls `GET /next-scenario` again to continue the loop.

### POST `/api/sessions/{sessionId}/prompts/{promptId}`
Record a student's free-text answer to an LLM-generated prompt (the `promptId` may be created server-side when the LLM generates follow-ups). The backend replies with the next AI turn; once the scenario is satisfied it sets `status` to `completed` to signal the student can move on.
- **Request body**
  ```json
  {
    "studentId": "stud_19ab",
    "message": "I'd start by searching student housing groups and set a â‚¬600 rent budget.",
    "scenarioId": "scn_b58c3d72-1e8a-4af5-a0c6-c0ef987ad123",
    "timestamp": "2025-11-15T08:42:12Z"
  }
  ```
- **Response** `200`
  ```json
  {
    "promptId": "prm_0c1d6f2b",
    "aiReply": "Great start. How will you ensure the apartment stays within budget while covering utilities?",
    "status": "in_progress",
    "accepted": false,
    "updatedStats": null,
    "effectsSummary": null
  }
  ```
- **Completed response** `200`
  ```json
  {
    "promptId": "prm_0c1d6f2b",
    "aiReply": "Sounds like a solid plan. You've successfully secured housing within budget!",
    "status": "completed",
    "accepted": true,
    "effects": [
      { "stat": "wealth", "delta": -12 },
      { "stat": "happiness", "delta": 5 },
      { "stat": "riskTaking", "delta": -3 }
    ],
    "effectsSummary": "Balanced savings and comfort, boosting happiness by 5 points.",
    "updatedStats": { "wealth": 20, "health": 18, "happiness": 50 }
  }
  ```

> The frontend should wait for `status: "completed"` before surfacing the stat summary modal and enabling the **Next scenario** action.

### Scenario completion
The frontend **does not** call a separate endpoint to submit final answers. Completion is conveyed by the `status: "completed"` payload returned from the last `POST /prompts` call. Persisted stats, pace tracking, and leaderboard updates happen server-side when that completion message is emitted.

## ðŸ“Š Live dashboards & analytics

### GET `/api/sessions/{sessionId}/leaderboard`
Provide ranking data for players plus per-stat deltas for the on-device leaderboard.
- **Response** `200`
  ```json
  {
    "updatedAt": "2025-11-15T08:50:00Z",
    "entries": [
      {
        "rank": 1,
        "studentId": "stud_19ab",
        "nickname": "Nova",
        "wealth": 45,
        "health": 30,
        "happiness": 55,
        "scenariosDone": 4
      }
    ]
  }
  ```

### GET `/api/sessions/{sessionId}/analytics/summary`
Teacher dashboard snapshot combining stat distributions, habit averages, and AI recommendations so the frontend can tell an engaging classroom story.
- **Response** `200`
  ```json
  {
    "classroomSummary": {
      "students": 26,
      "engagementRate": 0.92,
      "avgScenariosCompleted": 5.1
    },
    "statDistributions": {
      "wealth": { "median": 28, "p90": 60, "min": -10, "max": 75 },
      "happiness": { "median": 35, "p90": 70, "min": 5, "max": 88 }
    },
    "habitAverages": {
      "riskTaking": { "mean": 4.7, "trend": "rising" },
      "overTrusting": { "mean": 1.2, "trend": "stable" },
      "laziness": { "mean": -0.6, "trend": "falling" },
      "impulsiveness": { "mean": 3.1, "trend": "rising" }
    },
    "leaderboardHighlights": [
      { "studentId": "stud_19ab", "nickname": "Nova", "stat": "wealth", "value": 72 },
      { "studentId": "stud_71ab", "nickname": "Kai", "stat": "happiness", "value": 85 }
    ],
    "recommendations": [
      {
        "curriculumRef": "OPO-3.1",
        "summary": "Review rental contract clauses in next lesson",
        "rationale": "62% of class over-trusted the first offer they received."
      }
    ]
  }
  ```

### GET `/api/sessions/{sessionId}/students/{studentId}/insights`
Expose an individualâ€™s narrative insight plus structured highlights so the UI can show a compelling recap card.
- **Response** `200`
  ```json
  {
    "studentId": "stud_19ab",
    "summary": "Nova navigated housing choices cautiously, boosting happiness while keeping spending under control.",
    "weakPoints": [
      { "stat": "overTrusting", "reason": "Accepted 3 of 4 offers without comparing terms" },
      { "stat": "wealth", "reason": "Savings rate stayed below 5% for two scenarios" }
    ],
    "strongPoints": [
      { "stat": "happiness", "reason": "Consistently chose balanced lifestyle trade-offs" },
      { "stat": "riskTaking", "reason": "Avoided high-risk credit products" }
    ],
    "trend": {
      "wealth": [20, 24, 32, 28],
      "riskTaking": [0, 3, 6, 2]
    }
  }
  ```

## ðŸ“„ Reporting & exports

### GET `/api/sessions/{sessionId}/reports/classroom.pdf`
Generate the AI-authored PDF summarizing the session for the school system.
- **Response** `200` `application/pdf`
  - Binary stream containing the PDF; also include `Content-Disposition: attachment`.
- **Errors**: `404` session not found, `409` report still generating.

### GET `/api/teachers/{teacherId}/sessions/{sessionId}/history`
Expose longitudinal data when classes replay the simulation across semesters.
- **Response** `200`
  ```json
  {
    "sessionId": "sess_72cf",
    "runs": [
      { "runId": "2024_fall", "medianWealth": 22, "medianHabits": { "riskTaking": 4 } },
      { "runId": "2025_spring", "medianWealth": 35, "medianHabits": { "riskTaking": 1 } }
    ]
  }
  ```

---
**Security & transport**: All endpoints require HTTPS. Teacher-facing endpoints expect a bearer token from `/api/auth/login`; student gameplay endpoints accept either the same token or a short-lived session token issued at join time.
